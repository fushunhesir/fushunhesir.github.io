---
layout: wiki
title: 中断和设备驱动
wiki: MIT-6.S081
order: 6
---

*中断是硬件请求CPU处理的机制，驱动是操作系统中与设备交互的程序*

## 硬件

**外设**：在主板上的各种芯片，以及可以连接到主板的各种设备

`PLIC`：中断管理设备，接收多个设备的中断信号将其映射为对应的**中断号**，然后将中断号传给CPU核心，CPU核心根据中断号执行相应的中断处理程序。

`PILC`**具体处理流程**

1. PLIC会通知当前有一个待处理的中断

2. 其中一个CPU核会Claim接收中断，这样PLIC就不会把中断发给其他的CPU处理

3. CPU核处理完中断之后，CPU会通知PLIC

4. PLIC将不再保存中断的信息

## 中断

仍然利用`TRAP`机制实现，与**系统调用**和**缺页异常**采用同一种机制实现。但是仍然存在一些**差异**
* **异步**：中断和当前运行在CPU上的进程没有任何关系。而系统调用需要保存进程上下文。
* **并发**：产生中断的外设和CPU是相互独立，同时运行的，是真正的并行运行。例如网卡和CPU
* **对设备编程**：中断需要对设备进行编程，控制设备操作。

所有外设都连接到CPU上，通过`PLIC`(Platform Level Interrupt Control)来管理设备中断，路由中断到某个CPU核心

### 中断相关寄存器

* `SIE`：不同的位针对不同中断的使能。分别针对外部设备中断，软件中断使能以及定时器中断使能。
* `SSTATUS`：控制所有中断的使能。`SIE`和`SSTATUS`在每个CPU核中都有。
* `SIP`：发生中断时，保存中断类型。
* `SCAUSE`：保存陷阱的类型
* `STVEC`：保存程序计数器，保证中断、缺页异常或者系统调用结束后，程序能够继续正常执行。

## 驱动

**定义**：管理内核的代码就是驱动，**驱动都在内核中**。

**架构**：驱动的架构一般分为`top`和`bottom`两个部分，其中`bottom`一般是中断处理程序，当某个CPU核心接收中断就会调用该程序。`top`是提供给用户进程或内核其他部分程序调用的**接口**，例如`read()`和`write()`。

**读写**：驱动中包含存储数据的`buffer`，无论是`top`还是`bottom`中的程序都可以对其进行读写。但是由于`bottom`中的`interrupt handler`使用内核页表，因为中断例程是独立于进程的，所以不能随意读写数据。

## 设备编程

通过`I/O`端口映射，主板厂商将设备映射到物理地址上，便可以用与读写内存相同的方式对设备进行编程，虽然这些设备并非真实存在`RAM`中。
