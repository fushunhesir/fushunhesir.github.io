---
layout: wiki
wiki: MIT-6.S081
title: 调度
order: 8
---

操作系统运行中同时运行的进程通常比核心的数量多，那么这些进程是怎样“同时”运行的呢？操作系统给这些进程提供了怎样的抽象呢？操作系统如何实现这个抽象的呢？

## 复用

`xv6`在两种情况下会发生进程切换，第一种是当`IO`操作完成时，存在等待它的进程，`sleep-wakeup`机制会进行进程切换；第二种是一个进程的时间片到时。

这样就给每一个进程提供了CPU的抽象。宏观上来看，似乎每个进程都有自己独占的CPU，就类似于页表使每个进程仿佛有自己的独有内存一样。

在设计这样的一个抽象的时候。我们需要考虑一些问题：

* 如何实现一个进程切换到另外一个进程？虽然其上下文切换的思想很简单，但是代码写起来却相当麻烦。
* 如何实现切换进程的同时用户无法感知？在`xv6`中使用定时器来实现的。
* 如何避免就绪进程队列的竞争条件问题？多个CPU会竞争就绪队列的进程，需要用`lock`来解决。
* 如何对已结束进程的所有资源进行回收？虽然进程本身可以释放部分资源，但是它无法释放一些自己的核心资源，比如内核堆栈。

## 上下文切换

<img src="https://cdn.jsdelivr.net/gh/fushunhesir/blog-images@main/imgs/%E5%A4%8D%E7%94%A8.png" alt="image-20230515211525260" style="zoom:25%;" />

