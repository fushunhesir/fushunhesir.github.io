---
layout: wiki
title: 缺页异常
wiki: MIT-6.S081
order: 5
---

### 缺页异常

*一种辅助实现懒加载的机制*

* **处理缺页异常**

  * **引发缺页异常的虚拟地址**：存储在`STVAL`寄存器中
  * **引发缺页异常的原因**：存储在`SCAUSE`寄存器中
  * **引发缺页异常的指令地址**：存储在`SEPC`寄存器中

  利用以上三个寄存器的信息，就能知道进入内核后如何处理缺页异常，并知道回到用户态时需要重新执行的指令的地址。

* **懒内存分配机制**：在进程申请内存的时候，并不立即分配内存并映射到该进程的地址空间，而是仅对该进程的栈顶指针进行修改，等到进程真正使用申请的内存时，通过触发缺页错误进入内核从而真正分配物理内存。

* **未使用时0填充机制**

  * **地址空间**：进程地址空间有三个区域，其中`text`区域存放指令，`data`区域存放初始化的全局变量，`BSS`区域存放未初始化或初始化为0的全局变量

  * **原理**：将BSS区域的所有页面全部映射到一个全为0的物理页面，从而节省程序启动时的物理内存分配。将BSS区域所有页面设置为只读，通过触发缺页异常进入内核真正分配一个全0的物理内存，并重新执行指令。

* **写时复制机制**：`fork`系统调用创建子进程，子进程的页表和父进程页表共享物理内存，将子进程与父进程的`PTES`均设置为只读，只有当两者中任一个进程对内存有`write`时才会分配并复制内存，并将该页面映射到子进程。从而优化`fork`后立马调用`exec`的场景。

* **按需分配页面**：在加载进程时，只加载部分指令到内存，其余`PTES`通过缺页异常来懒加载。涉及到页面置换问题。

* **内存映射文件**

  * **系统调用**：`mmap()`从文件描述符对应的文件的偏移量的位置开始，映射长度为len的内容到虚拟内存地址VA，同时我们需要加上一些保护，比如只读或者读写。
  * **原理**：将完整或者部分文件加载到内存中，这样就可以通过内存地址相关的load或者store指令来操纵文件。
